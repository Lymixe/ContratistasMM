@model DetalleProyectoViewModel
@{
    ViewData["Title"] = $"Detalle: {Model.Proyecto.Nombre}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container content-section">
    <!-- SECCIÓN DE ENCABEZADO DEL PROYECTO -->
    <div class="project-detail-header-card">
        <div class="row g-0">
            <div class="col-md-4">
                <img src="@(Model.Proyecto.ImagenUrl ?? "/img/placeholder.png")" class="img-fluid rounded-start" alt="Imagen de @Model.Proyecto.Nombre">
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h3 class="card-title">@Model.Proyecto.Nombre</h3>
                        <span class="badge status-badge-@(Model.Proyecto.Estado.Replace(" ", ""))">@Model.Proyecto.Estado</span>
                    </div>
                    <p class="card-text">@Model.Proyecto.Descripcion</p>
                    <div class="row project-stats">
                        <div class="col-6"><i class="far fa-calendar-alt"></i> <strong>Fecha de Inicio:</strong> @Model.Proyecto.FechaInicio?.ToString("d/M/yyyy")</div>
                        <div class="col-6"><i class="fas fa-chart-line"></i> <strong>Progreso General:</strong> @Model.Proyecto.Progreso%</div>
                    </div>
                    <div class="progress mt-3" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: @Model.Proyecto.Progreso%;" aria-valuenow="@Model.Proyecto.Progreso" aria-valuemin="0" aria-valuemax="100">@Model.Proyecto.Progreso%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PESTAÑAS DE NAVEGACIÓN -->
    <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-seguimiento-tab" data-bs-toggle="pill" data-bs-target="#pills-seguimiento" type="button" role="tab">Seguimiento de Obra</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-documentos-tab" data-bs-toggle="pill" data-bs-target="#pills-documentos" type="button" role="tab">Documentos Subidos</button>
        </li>
    </ul>

    <!-- CONTENIDO DE LAS PESTAÑAS -->
    <div class="tab-content" id="pills-tabContent">
        <!-- PESTAÑA: SEGUIMIENTO DE OBRA -->
        <div class="tab-pane fade show active" id="pills-seguimiento" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Hitos del Proyecto</h4>
                <button class="btn btn-primary js-crear-hito-btn" data-proyecto-id="@Model.Proyecto.Id">+ Agregar Hito</button>
            </div>
            @foreach (var hito in Model.Proyecto.Hitos.OrderBy(h => h.FechaEstimada))
            {
                <div class="hito-card">
                    <div class="hito-icon @hito.Estado.ToLower()">
                        @if(hito.Estado == "Completado") { <i class="fas fa-check-circle"></i> }
                        else if(hito.Estado == "En Progreso") { <i class="fas fa-hourglass-half"></i> }
                        else { <i class="far fa-clock"></i> }
                    </div>
                    <div class="hito-content">
                        <div class="d-flex justify-content-between">
                            <h5>@hito.Nombre</h5>
                             <span class="badge status-badge-@(hito.Estado.Replace(" ", ""))">@hito.Estado</span>
                        </div>
                        <p>@hito.Descripcion</p>
                        <small class="text-muted"><i class="far fa-calendar-alt"></i> Fecha estimada: @hito.FechaEstimada?.ToString("d/M/yyyy")</small>
                    </div>
                </div>
            }
        </div>

        <!-- PESTAÑA: DOCUMENTOS -->
        <div class="tab-pane fade" id="pills-documentos" role="tabpanel">
            <h4>Gestión de Documentos</h4>
            <ul class="list-group document-list-admin">
                @foreach (var doc in Model.Proyecto.Documentos)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="far fa-file-alt"></i>
                            <a href="~/documentos/@doc.UrlArchivo" target="_blank">@doc.Nombre</a>
                            <small class="text-muted">(@doc.Clasificacion)</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-@doc.Id" checked="@doc.EsVisibleParaCliente">
                            <label class="form-check-label" for="switch-@doc.Id">Visible para cliente</label>
                        </div>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>  

<div id="modal-placeholder"></div>

@section Scripts {
    <script>
        $(function () {
            var placeholderElement = $('#modal-placeholder');
            
            // Script para abrir el modal de CREAR HITO
            $('.js-crear-hito-btn').on('click', function () {
                var proyectoId = $(this).data('proyecto-id');
                $.get('/Admin/Proyectos/CrearHito?proyectoId=' + proyectoId, function (data) {
                    placeholderElement.html(data);
                    placeholderElement.find('.modal').modal('show');
                });
            });
            
            // Limpia el placeholder cuando CUALQUIER modal se oculta
            $('body').on('hidden.bs.modal', '.modal', function () {
                placeholderElement.empty();
            });
        });
        $('.document-list-admin .form-check-input').on('change', function () {
            var switchElement = $(this);
            var docId = switchElement.attr('id').replace('switch-', '');
            var isVisible = switchElement.is(':checked');
            
            // Petición POST para actualizar la visibilidad en la BD
            $.post('/Admin/Proyectos/CambiarVisibilidadDocumento', 
            { 
                id: docId, 
                esVisible: isVisible 
            })
            .done(function(response) {
                console.log(response.message); // Opcional: mostrar un mensaje de éxito
            })
            .fail(function() {
                alert('Hubo un error al actualizar la visibilidad.');
                // Revertir el switch si la llamada falla
                switchElement.prop('checked', !isVisible);
            });
        });
    </script>
}